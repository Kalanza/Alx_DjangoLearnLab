{% extends 'bookshelf/base.html' %}

{% block content %}
<h1>Book Library</h1>

<!-- Secure search form with CSRF protection -->
<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
    <form method="get" class="search-form">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            {{ search_form.search_query }}
            {{ search_form.search_type }}
            <button type="submit" class="btn btn-primary">Search</button>
            {% if request.GET.search_query %}
                <a href="{% url 'book_list' %}" class="btn">Clear</a>
            {% endif %}
        </div>
    </form>
    {% if total_books %}
        <p style="margin-top: 10px; color: #6c757d;">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_books }} book{{ total_books|pluralize }}
        </p>
    {% endif %}
</div>

{% if page_obj %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f8f9fa;">
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Title</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Author</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Publication Year</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for book in page_obj %}
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 12px;">{{ book.title|escape }}</td> <!-- Escape output for XSS protection -->
                <td style="padding: 12px;">{{ book.author|escape }}</td>
                <td style="padding: 12px;">{{ book.publication_year }}</td>
                <td style="padding: 12px;">
                    {% if perms.bookshelf.can_view %}
                        <a href="{% url 'book_detail' book.pk %}" class="btn btn-sm">View</a>
                    {% endif %}
                    {% if perms.bookshelf.can_edit %}
                        <a href="{% url 'book_edit' book.pk %}" class="btn btn-sm">Edit</a>
                    {% endif %}
                    {% if perms.bookshelf.can_delete %}
                        <a href="{% url 'book_delete' book.pk %}" class="btn btn-sm btn-danger">Delete</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination with security considerations -->
    {% if page_obj.has_other_pages %}
        <div style="margin-top: 20px; text-align: center;">
            <nav>
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.search_query %}&search_query={{ request.GET.search_query|urlencode }}{% endif %}{% if request.GET.search_type %}&search_type={{ request.GET.search_type|urlencode }}{% endif %}" class="btn">First</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search_query %}&search_query={{ request.GET.search_query|urlencode }}{% endif %}{% if request.GET.search_type %}&search_type={{ request.GET.search_type|urlencode }}{% endif %}" class="btn">Previous</a>
                {% endif %}
                
                <span style="margin: 0 10px;">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search_query %}&search_query={{ request.GET.search_query|urlencode }}{% endif %}{% if request.GET.search_type %}&search_type={{ request.GET.search_type|urlencode }}{% endif %}" class="btn">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search_query %}&search_query={{ request.GET.search_query|urlencode }}{% endif %}{% if request.GET.search_type %}&search_type={{ request.GET.search_type|urlencode }}{% endif %}" class="btn">Last</a>
                {% endif %}
            </nav>
        </div>
    {% endif %}
{% else %}
    <div style="text-align: center; padding: 40px;">
        <p>No books available in the library.</p>
        {% if perms.bookshelf.can_create %}
            <p><a href="{% url 'book_create' %}" class="btn btn-primary">Add the first book</a></p>
        {% endif %}
    </div>
{% endif %}

<!-- Action buttons -->
<div style="margin-top: 30px; text-align: center;">
    {% if perms.bookshelf.can_create %}
        <a href="{% url 'book_create' %}" class="btn btn-primary">Add New Book</a>
    {% endif %}
</div>

<!-- Add styling for better UX and security -->
<style>
.search-form .form-control {
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}
.btn {
    padding: 8px 16px;
    text-decoration: none;
    border-radius: 4px;
    border: 1px solid transparent;
    background-color: #007bff;
    color: white;
    font-size: 14px;
    cursor: pointer;
}
.btn:hover {
    background-color: #0056b3;
}
.btn-primary {
    background-color: #007bff;
}
.btn-danger {
    background-color: #dc3545;
}
.btn-danger:hover {
    background-color: #c82333;
}
.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
    margin-right: 5px;
}
</style>
{% endblock %}
